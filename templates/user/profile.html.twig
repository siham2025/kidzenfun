{% extends 'base.html.twig' %}

{% block title %}Mon profil - Kidzen&fun
{% endblock %}

{% block stylesheets %}
	{{ encore_entry_link_tags('app') }}
{% endblock %}

{% block body %}
	<section class="profile-banner" style="--profile-banner:url('{{ asset('images/profile2.png') }}')" loading="lazy">
		<div class="container-profile">
			<h1>Bienvenue,
				{{ app.user.firstname|default('Nom de l’utilisateur') }}</h1>
			<p>Découvrez vos activités favorites et gérez votre profil ici.</p>

			<div class="profile-buttons">
				<a href="#" class="btn btn-secondary">Modifier</a>
				<form action="{{ path('app_logout') }}" method="post" style="display:inline;">
					<input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">

				</form>
				{# <a href="{{ path('app_logout') }}" class="btn btn-outline">Déconnexion</a> #}
			</div>
		</div>
	</section>

	{# <section class="profile-actions">
					<div
						class="container">{# <a href="{{ path('app_home') }}" class="btn btn-primary">Chercher une activité</a> #}
	{# </div> #}
	{# </section> #}

		<section class="favorites"> <div class="container-profile">
			<h2>Mes activités favorites</h2>
			<div class="favorites-grid">
				{% for activity in favorites %}
					<div class="activity-card">
						<img src="{{ asset('images/activities/' ~ activity.image) }}" alt="{{ activity.title }}" loading="lazy">
						<h4>{{ activity.title }}</h4>
						<p>Âge :
							{{ activity.ageGroup }}</p>
						<p>Thème :
							{{ activity.themes[0].name }}</p>
						<a href="{{ path('activity_detail', { id: activity.id }) }}" class="btn btn-sm">Découvrir</a>
						{# icone de suppression de l'activité #}
						<form class="delete-favorite-form" method="post" action="{{ path('remove_favorite', { id: activity.id }) }}">
							<button type="submit" class="tooltip-btn" data-activity-title="{{ activity.title }}" aria-label="Supprimer cette activité de vos favoris">
								<i class="fas fa-trash"></i>
								<span class="tooltip-text">Supprimer</span>
							</button>
						</form>
					</div>

				{% else %}
					<p>Aucune activité en favori pour le moment.</p>
				{% endfor %}

			</div>
		</div>
	</section>
	{# Modal de confirmation suppression favori #}
	<div id="favorite-modal-overlay" class="favorite-modal-overlay favorite-modal-hidden">
		<div class="favorite-modal">
			<h2 class="favorite-modal-title">Confirmer la suppression</h2>
			<p class="favorite-modal-text" id="favorite-modal-text">
				Êtes-vous sûr de vouloir supprimer cette activité de vos favoris ?
			</p>
			<div class="favorite-modal-actions">
				<button type="button" id="favorite-cancel-btn" class="favorite-btn favorite-btn-secondary">
					Annuler
				</button>
				<button type="button" id="favorite-confirm-btn" class="favorite-btn favorite-btn-danger">
					Confirmer
				</button>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const overlay   = document.getElementById('favorite-modal-overlay');
            const cancelBtn = document.getElementById('favorite-cancel-btn');
            const confirmBtn= document.getElementById('favorite-confirm-btn');
            const textEl    = document.getElementById('favorite-modal-text');

            if (!overlay || !cancelBtn || !confirmBtn) {
                return;
            }

            let formToSubmit = null;

            // Intercepter la soumission des formulaires de suppression
            document.querySelectorAll('.delete-favorite-form').forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault(); // empêche l'envoi immédiat
                    formToSubmit = form;

                    // Optionnel : affiche le titre de l'activité dans le texte du modal
                    const btn = form.querySelector('.tooltip-btn');
                    const title = btn ? btn.getAttribute('data-activity-title') : null;

                    if (title && textEl) {
                        textEl.textContent =
                            'Êtes-vous sûr de vouloir supprimer "' + title + '" de vos favoris ?';
                    } else if (textEl) {
                        textEl.textContent =
                            'Êtes-vous sûr de vouloir supprimer cette activité de vos favoris ?';
                    }

                    overlay.classList.remove('favorite-modal-hidden');
                });
            });

            // Bouton Annuler
            cancelBtn.addEventListener('click', function () {
                overlay.classList.add('favorite-modal-hidden');
                formToSubmit = null;
            });

            // Bouton Confirmer
            confirmBtn.addEventListener('click', function () {
                if (formToSubmit) {
                    formToSubmit.submit();
                }
            });

            // Fermer en cliquant sur l’overlay
            overlay.addEventListener('click', function (event) {
                if (event.target === overlay) {
                    overlay.classList.add('favorite-modal-hidden');
                    formToSubmit = null;
                }
            });
        });
    </script>
{% endblock %}